<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduBattle - N·ªÅn t·∫£ng h·ªçc t·∫≠p & Thi ƒë·∫•u</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Style for drag/drop items in Jumble question */
        .jumble-word {
            display: inline-block;
            padding: 8px 12px;
            margin: 4px;
            background-color: #e0f2f1; /* Tailwind teal-50 */
            border: 1px solid #009688; /* Tailwind teal-600 */
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .jumble-word:hover { background-color: #b2dfdb; }

        /* Animation for correct answer flash */
        .flash-green {
            animation: flashGreen 0.2s ease-out;
        }
        @keyframes flashGreen {
            0% { background-color: #f0fff4; }
            50% { background-color: #34d399; } /* Tailwind green-400 */
            100% { background-color: #f0fff4; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen overflow-hidden">

    <!-- App Root -->
    <div id="app" class="h-full w-full"></div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, 
                 createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        let appId, firebaseConfig;
        const TEACHER_CODE = "ruands10"; // M√£ x√°c nh·∫≠n gi√°o vi√™n

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                // Fallback config (Public Demo)
                firebaseConfig = {
                    apiKey: "AIzaSyBTHcX_Ha3CZPNHY8vcWilcOe4oF3f6rKU",
                    authDomain: "lmsapp-19548.firebaseapp.com",
                    projectId: "lmsapp-19548",
                    storageBucket: "lmsapp-19548.firebasestorage.app",
                    messagingSenderId: "584664617140",
                    appId: "1:584664617140:web:8ffa1650976191c45887e1",
                    measurementId: "G-1TK7RW8H15"
                };
            }
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } catch (e) { console.error(e); firebaseConfig = {}; }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Helper Paths
        const getPath = (col) => `artifacts/${appId}/public/data/${col}`;
        const getRef = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

        // --- 2. STATE MANAGEMENT ---
        const state = {
            user: null,
            profile: null,
            view: 'dashboard', 
            data: {
                assignments: [],
                submissions: [],
                users: [],
                matches: [],
                vocabulary: [] // Store loaded vocabulary here
            },
            ui: {
                isCreatingAssignment: false,
                takingAssignmentId: null,
                assignmentAnswers: {},
                newAssignment: { title: '', questions: [] },
                activeMatch: null,
                matchQIndex: 0,
                authMode: 'login',
                newQuestionType: 'mcq',
                competitionMode: 'lobby',
                lastFinishedMatch: null, // Th√™m bi·∫øn l∆∞u k·∫øt qu·∫£ tr·∫≠n ƒë·∫•u cu·ªëi c√πng
                hasAnsweredCurrentQ: false // C·ªù ki·ªÉm tra ƒë√£ tr·∫£ l·ªùi c√¢u h·ªèi hi·ªán t·∫°i ch∆∞a
            },
            isAuthReady: false 
        };

        // H√†m t·∫°o m√£ ph√≤ng ng·∫´u nhi√™n 6 k√Ω t·ª±
        const generateRoomCode = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        };
        
        // --- 3. UTILITIES & DATA LOADING ---

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const color = type === 'error' ? 'bg-red-500' : 'bg-green-600';
            el.className = `${color} text-white px-6 py-3 rounded-lg shadow-xl animate-bounce mb-2 transition-all duration-500`;
            el.textContent = msg;
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 500);
            }, 3000);
        };

        const renderIcons = () => lucide.createIcons();

        // TEXT-TO-SPEECH (Web Speech API)
        window.speakWord = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN'; // Set language to Chinese
                utterance.rate = 0.8; // Slightly slower for clarity
                
                window.speechSynthesis.speak(utterance);
            } else {
                showToast("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ √¢m thanh.", "error");
            }
        };

        // LOAD DATA FROM LOCAL FILE
        const loadVocabulary = async () => {
            try {
                const response = await fetch('dataLMS/data.txt');
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const text = await response.text();
                const vocab = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .map(line => {
                        const parts = line.split('|');
                        if (parts.length >= 3) {
                            return { word: parts[0].trim(), pinyin: parts[1].trim(), meaning: parts[2].trim() };
                        }
                        return null;
                    })
                    .filter(item => item !== null);

                if (vocab.length === 0) throw new Error("File r·ªóng");
                
                state.data.vocabulary = vocab;
                console.log("Loaded vocabulary:", vocab.length, "words");

            } catch (e) {
                console.warn("Kh√¥ng load ƒë∆∞·ª£c dataLMS/data.txt, s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u.", e);
                // D·ªØ li·ªáu m·∫´u fallback
                state.data.vocabulary = [
                    { word: '‰Ω†Â•Ω', pinyin: 'n«ê h«éo', meaning: 'Xin ch√†o' },
                    { word: 'Ë∞¢Ë∞¢', pinyin: 'xi√®xie', meaning: 'C·∫£m ∆°n' },
                    { word: 'ÂÜçËßÅ', pinyin: 'z√†iji√†n', meaning: 'T·∫°m bi·ªát' },
                    { word: 'ËÄÅÂ∏à', pinyin: 'l«éoshƒ´', meaning: 'Gi√°o vi√™n' },
                    { word: 'Â≠¶Áîü', pinyin: 'xu√©sheng', meaning: 'H·ªçc sinh' },
                    { word: 'ÊúãÂèã', pinyin: 'p√©ngyou', meaning: 'B·∫°n b√®' },
                    { word: 'Áà±', pinyin: '√†i', meaning: 'Y√™u' },
                    { word: 'ÂñúÊ¨¢', pinyin: 'x«êhuan', meaning: 'Th√≠ch' },
                    { word: 'Áå´', pinyin: 'mƒÅo', meaning: 'Con m√®o' },
                    { word: 'Áãó', pinyin: 'g«íu', meaning: 'Con ch√≥' },
                    { word: 'Ê∞¥', pinyin: 'shu«ê', meaning: 'N∆∞·ªõc' },
                    { word: '‰π¶', pinyin: 'sh≈´', meaning: 'S√°ch' }
                ];
                if (state.view === 'competition') {
                    showToast("ƒêang d√πng d·ªØ li·ªáu m·∫´u (kh√¥ng t√¨m th·∫•y dataLMS/data.txt)", "error");
                }
            }
        };

        // --- 4. LOGIC T·∫†O C√ÇU H·ªéI ƒê·∫§U TR∆Ø·ªúNG M·ªöI ---
        const generateArenaQuestions = () => {
            const vocabList = state.data.vocabulary;
            const questions = [];
            if (vocabList.length < 4) return [];

            for(let i = 0; i < 10; i++) {
                const correctItem = vocabList[Math.floor(Math.random() * vocabList.length)];
                const type = Math.floor(Math.random() * 5) + 1;
                let qText = "", qOptions = [], correctAnswerVal = "", audioWord = null;

                const distractors = [];
                while(distractors.length < 3) {
                    const item = vocabList[Math.floor(Math.random() * vocabList.length)];
                    if (item.word !== correctItem.word && !distractors.includes(item)) distractors.push(item);
                }

                switch(type) {
                    case 1: 
                        qText = `Nghƒ©a c·ªßa t·ª´ <span class="text-blue-600 font-bold text-3xl mx-2">${correctItem.word}</span> l√† g√¨?`;
                        correctAnswerVal = correctItem.meaning;
                        qOptions = [correctItem.meaning, ...distractors.map(d => d.meaning)];
                        break;
                    case 2: 
                        qText = `Pinyin c·ªßa t·ª´ <span class="text-blue-600 font-bold text-3xl mx-2">${correctItem.word}</span> l√† g√¨?`;
                        correctAnswerVal = correctItem.pinyin;
                        qOptions = [correctItem.pinyin, ...distractors.map(d => d.pinyin)];
                        break;
                    case 3: 
                        qText = `T·ª´ n√†o c√≥ nghƒ©a l√† <span class="text-green-600 font-bold text-2xl mx-2">"${correctItem.meaning}"</span>?`;
                        correctAnswerVal = correctItem.word;
                        qOptions = [correctItem.word, ...distractors.map(d => d.word)];
                        break;
                    case 4: 
                        qText = `Nghe v√† ch·ªçn t·ª´ v·ª±ng ƒë√∫ng:`;
                        audioWord = correctItem.word;
                        correctAnswerVal = correctItem.word;
                        qOptions = [correctItem.word, ...distractors.map(d => d.word)];
                        break;
                    case 5: 
                        qText = `Nghe v√† ch·ªçn nghƒ©a ƒë√∫ng:`;
                        audioWord = correctItem.word;
                        correctAnswerVal = correctItem.meaning;
                        qOptions = [correctItem.meaning, ...distractors.map(d => d.meaning)];
                        break;
                }

                const shuffledOptions = qOptions.sort(() => Math.random() - 0.5);
                questions.push({
                    type: 'arena_quiz',
                    qTypeId: type,
                    text: qText,
                    options: shuffledOptions,
                    correct: shuffledOptions.indexOf(correctAnswerVal),
                    audioWord: audioWord
                });
            }
            return questions;
        };

        // --- 5. SETUP LISTENERS & AUTH ---

        const initAuth = async () => {
            await loadVocabulary();
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            }
        };

        const setupListeners = (uid) => {
            // Profile
            onSnapshot(doc(db, getPath('users'), uid), (snap) => {
                if(snap.exists()) {
                    state.profile = snap.data();
                    renderApp();
                } else if (state.user) {
                    state.profile = null;
                    renderApp();
                }
            });
            // Assignments
            onSnapshot(getRef('assignments'), (snap) => {
                state.data.assignments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'assignments' || state.view === 'dashboard') renderApp();
            });
            // Submissions
            onSnapshot(getRef('submissions'), (snap) => {
                state.data.submissions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'assignments' || state.view === 'dashboard') renderApp();
            });
            // Users (Rank)
            onSnapshot(getRef('users'), (snap) => {
                state.data.users = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'ranking') renderApp();
            });
            
            // --- OPTIMIZED MATCH LISTENER ---
            onSnapshot(getRef('matches'), (snap) => {
                state.data.matches = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const uid = state.user?.uid;
                const prevMatch = state.ui.activeMatch; 
                const prevMode = state.ui.competitionMode;

                // Find active match
                state.ui.activeMatch = state.data.matches.find(m => 
                    (m.player1?.uid === uid || m.player2?.uid === uid) && m.status !== 'finished'
                );
                
                // Determine new mode based on match status
                let newMode = 'lobby';
                if (state.ui.activeMatch) {
                    newMode = state.ui.activeMatch.status === 'playing' ? 'playing' : 'waiting';
                }

                const isPlayingContainerExists = document.getElementById('match-playing-container');
                const isSameMode = prevMode === 'playing' && newMode === 'playing';

                // --- Ghi l·∫°i tr·∫≠n ƒë·∫•u v·ª´a k·∫øt th√∫c n·∫øu c√≥ ---
                if (prevMatch && prevMatch.status === 'playing' && newMode !== 'playing') {
                     // T√¨m l·∫°i tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c trong danh s√°ch (v√¨ n√≥ v·∫´n c√≤n trong state.data.matches)
                     const finishedMatch = state.data.matches.find(m => m.id === prevMatch.id && m.status === 'finished');
                     if (finishedMatch) {
                        state.ui.lastFinishedMatch = finishedMatch;
                        
                         // X√≥a tr·∫≠n ƒë·∫•u tr√™n Firestore sau khi l∆∞u k·∫øt qu·∫£ c·ª•c b·ªô ƒë·ªÉ d·ªçn d·∫πp
                         deleteDoc(doc(db, getPath('matches'), finishedMatch.id))
                             .catch(e => console.error("Error deleting finished match:", e));
                     }
                }
                
                // --- X·ª≠ l√Ω k·∫øt qu·∫£ tr·∫≠n ƒë·∫•u sau khi activeMatch chuy·ªÉn v·ªÅ null ---
                if (prevMatch && prevMatch.status === 'playing' && state.ui.activeMatch === null) {
                    // K√≠ch ho·∫°t th√¥ng b√°o d·ª±a tr√™n k·∫øt qu·∫£ ƒë√£ l∆∞u
                    const finishedMatch = state.ui.lastFinishedMatch;

                    if (finishedMatch) {
                        const isP1 = finishedMatch.player1.uid === uid;
                        const myScore = isP1 ? finishedMatch.player1.score : finishedMatch.player2.score;
                        const opponentScore = isP1 ? finishedMatch.player2.score : finishedMatch.player1.score;

                        let message;
                        let type;

                        // X√°c ƒë·ªãnh ng∆∞·ªùi chi·∫øn th·∫Øng v√† c·∫≠p nh·∫≠t th√¥ng b√°o
                        if (myScore > opponentScore) {
                            message = `üèÜ CH√öC M·ª™NG! B·∫°n ƒë√£ chi·∫øn th·∫Øng v·ªõi ${myScore} - ${opponentScore} ƒëi·ªÉm!`;
                            type = 'success';
                        } else if (myScore < opponentScore) {
                            message = `üò≠ H√£y c·ªë g·∫Øng h∆°n n·ªØa! B·∫°n ƒë√£ thua ${myScore} - ${opponentScore} ƒëi·ªÉm.`;
                            type = 'error';
                        } else {
                            message = `ü§ù H√íA! Tr·∫≠n ƒë·∫•u k·∫øt th√∫c v·ªõi t·ª∑ s·ªë ${myScore} - ${opponentScore}.`;
                            type = 'success';
                        }
                        showToast(message, type);
                    }
                    
                    // Reset tr·∫°ng th√°i v√† ƒë·∫£m b·∫£o render l·∫°i lobby
                    state.ui.competitionMode = 'lobby';
                    state.ui.lastFinishedMatch = null;
                    // ƒê·∫£m b·∫£o c·ªù tr·∫£ l·ªùi ƒë∆∞·ª£c reset
                    state.ui.hasAnsweredCurrentQ = false; 
                    renderApp();
                    return;
                }
                // --- END CHECK FOR FINISHED GAME ---

                // C·∫≠p nh·∫≠t c·ª•c b·ªô c·ªù tr·∫£ l·ªùi
                if (state.ui.activeMatch && prevMatch && state.ui.activeMatch.qIndex !== prevMatch.qIndex) {
                    state.ui.hasAnsweredCurrentQ = false;
                }


                state.ui.competitionMode = newMode; // Update state

                if (state.view === 'competition') {
                    if (isSameMode && isPlayingContainerExists) {
                        // SMART UPDATE
                        if (
                            !prevMatch || 
                            prevMatch.player1.score !== state.ui.activeMatch.player1.score || 
                            prevMatch.player2.score !== state.ui.activeMatch.player2.score ||
                            state.ui.activeMatch.qIndex !== prevMatch.qIndex // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu index c√¢u h·ªèi thay ƒë·ªïi
                        ) {
                            // C·∫≠p nh·∫≠t matchQIndex c·ª•c b·ªô
                            state.ui.matchQIndex = state.ui.activeMatch.qIndex; 
                            updatePlayingUI();
                        }
                    } else {
                        // Full Re-render 
                        if (state.ui.activeMatch) {
                            state.ui.matchQIndex = state.ui.activeMatch.qIndex || 0; // ƒê·∫£m b·∫£o index ƒë∆∞·ª£c sync
                        }
                        renderApp();
                    }
                }
            });
        };

        const renderApp = () => {
            const appEl = document.getElementById('app');
            // N·∫øu Auth ch∆∞a s·∫µn s√†ng HO·∫∂C ch∆∞a c√≥ user HO·∫∂C ch∆∞a c√≥ profile, show m√†n h√¨nh Auth
            if (!state.isAuthReady || !state.user || !state.profile) {
                appEl.innerHTML = renderAuthScreen();
            } else {
                appEl.innerHTML = renderMainLayout();
            }
            renderIcons();
        };
        
        // --- 6. RENDERERS ---

        const renderAuthScreen = () => {
            const isRegister = state.ui.authMode === 'register';
            const currentRole = document.querySelector('input[name="role"]:checked')?.value || 'student';
            
            return `
                <div class="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <div class="text-center mb-8">
                            <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="book-open" class="text-white w-8 h-8"></i>
                            </div>
                            <h1 class="text-3xl font-bold text-slate-800">EduBattle</h1>
                            <p class="text-slate-500">N·ªÅn t·∫£ng h·ªçc t·∫≠p & thi ƒë·∫•u</p>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">${isRegister ? 'ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi' : 'ƒêƒÉng nh·∫≠p'}</h2>
                        <form onsubmit="${isRegister ? 'handleRegister(event)' : 'handleLogin(event)'}" class="space-y-4">
                            ${isRegister ? `
                                <div><input id="join-name" type="text" required class="w-full p-3 border rounded-lg" placeholder="H·ªç v√† t√™n"></div>
                                <div><input id="join-email" type="email" required class="w-full p-3 border rounded-lg" placeholder="Email"></div>
                                <div><input id="join-password" type="password" required class="w-full p-3 border rounded-lg" placeholder="M·∫≠t kh·∫©u"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="cursor-pointer border p-2 rounded text-center"><input type="radio" name="role" value="student" ${currentRole === 'student' ? 'checked' : ''} onchange="renderApp()"> H·ªçc sinh</label>
                                    <label class="cursor-pointer border p-2 rounded text-center"><input type="radio" name="role" value="teacher" ${currentRole === 'teacher' ? 'checked' : ''} onchange="renderApp()"> Gi√°o vi√™n</label>
                                </div>
                                ${currentRole === 'teacher' ? '<input id="teacher-code" type="text" class="w-full p-3 border border-purple-300 rounded-lg" placeholder="M√£ gi√°o vi√™n (ruands10)">' : ''}
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg">ƒêƒÉng k√Ω t√†i kho·∫£n</button>
                            ` : `
                                <div><input id="login-email" type="email" required class="w-full p-3 border rounded-lg" placeholder="Email"></div>
                                <div><input id="login-password" type="password" required class="w-full p-3 border rounded-lg" placeholder="M·∫≠t kh·∫©u"></div>
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg">ƒêƒÉng nh·∫≠p</button>
                            `}
                        </form>
                        <div class="mt-6 pt-4 border-t text-center text-sm">
                            <button onclick="setAuthMode('${isRegister ? 'login' : 'register'}')" class="font-bold text-blue-600 hover:text-blue-700 transition">
                                ${isRegister ? 'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p' : 'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderMainLayout = () => `
            <div class="flex h-screen bg-slate-50 overflow-hidden">
                <!-- Sidebar -->
                <div class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl flex-shrink-0">
                    <div class="p-6 border-b border-slate-800 flex items-center gap-3">
                        <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="book-open" class="text-white"></i></div>
                        <h1 class="text-xl font-bold text-white">EduBattle</h1>
                    </div>
                    <nav class="flex-1 p-4 space-y-2">
                        ${renderNavItem('dashboard', 'layout-dashboard', 'T·ªïng quan')}
                        ${renderNavItem('assignments', 'book-open', 'B√†i t·∫≠p')}
                        ${renderNavItem('competition', 'swords', 'ƒê·∫•u tr∆∞·ªùng')}
                        ${renderNavItem('ranking', 'trophy', 'X·∫øp h·∫°ng')}
                    </nav>
                    <div class="p-4 border-t border-slate-800">
                        <div class="flex items-center gap-3 mb-4 px-2">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${state.profile.role === 'teacher' ? 'bg-purple-500' : 'bg-blue-500'}">
                                ${state.profile.name.charAt(0)}
                            </div>
                            <div class="overflow-hidden">
                                <p class="text-sm font-medium text-white truncate">${state.profile.name}</p>
                                <p class="text-xs text-slate-400 capitalize">${state.profile.role === 'teacher' ? 'Gi√°o vi√™n' : 'H·ªçc sinh'}</p>
                            </div>
                        </div>
                        <button onclick="handleSignOut()" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-400 hover:bg-slate-800 rounded-lg transition-colors">
                            <i data-lucide="log-out" size="16"></i> ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col min-w-0">
                    <header class="bg-white shadow-sm px-8 py-4 flex justify-between items-center z-10">
                        <h2 class="text-2xl font-bold text-slate-800 capitalize">
                            ${state.view === 'dashboard' ? 'T·ªïng quan' : 
                              state.view === 'assignments' ? 'B√†i t·∫≠p v·ªÅ nh√†' :
                              state.view === 'competition' ? 'ƒê·∫•u tr∆∞·ªùng tr·ª±c tuy·∫øn' : 'B·∫£ng x·∫øp h·∫°ng'}
                        </h2>
                        <div class="px-4 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold flex items-center gap-2">
                            <i data-lucide="trophy" size="14"></i> ${state.profile.points} ƒëi·ªÉm
                        </div>
                    </header>
                    <main class="flex-1 overflow-auto p-8 fade-in">
                        ${renderViewContent()}
                    </main>
                </div>
            </div>
        `;

        const renderNavItem = (viewName, icon, label) => `
            <button onclick="changeView('${viewName}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${state.view === viewName ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}">
                <i data-lucide="${icon}" size="20"></i> <span class="font-medium">${label}</span>
            </button>
        `;

        const renderViewContent = () => {
            switch(state.view) {
                case 'dashboard': return renderDashboard();
                case 'assignments': return renderAssignments();
                case 'competition': return renderCompetition();
                case 'ranking': return renderRanking();
                default: return '';
            }
        };
        
        // DASHBOARD
        const renderDashboard = () => {
            const mySubmissions = state.data.submissions.filter(s => s.studentId === state.user.uid);
            const pending = state.data.assignments.length - mySubmissions.length;
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-4 rounded-xl bg-yellow-50 text-yellow-500"><i data-lucide="trophy"></i></div>
                        <div><p class="text-slate-500 text-sm">ƒêi·ªÉm t√≠ch l≈©y</p><p class="text-2xl font-bold text-slate-800">${state.profile.points}</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-4 rounded-xl bg-green-50 text-green-500"><i data-lucide="check-circle"></i></div>
                        <div><p class="text-slate-500 text-sm">B√†i t·∫≠p ƒë√£ l√†m</p><p class="text-2xl font-bold text-slate-800">${mySubmissions.length}</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-4 rounded-xl bg-orange-50 text-orange-500"><i data-lucide="clock"></i></div>
                        <div><p class="text-slate-500 text-sm">B√†i t·∫≠p ch·ªù</p><p class="text-2xl font-bold text-slate-800">${Math.max(0, pending)}</p></div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-8 text-white shadow-xl flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i, ${state.profile.name}!</h3>
                        <p class="text-blue-100 max-w-xl mb-6">
                            ${state.profile.role === 'student' ? 'B·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ chinh ph·ª•c c√°c th·ª≠ th√°ch h√¥m nay ch∆∞a?' : 'Qu·∫£n l√Ω l·ªõp h·ªçc v√† t·∫°o b√†i t·∫≠p m·ªõi.'}
                        </p>
                        <div class="flex gap-3">
                            <button onclick="changeView('assignments')" class="bg-white text-blue-700 px-6 py-2 rounded-lg font-bold hover:bg-blue-50 transition">
                                ${state.profile.role === 'student' ? 'L√†m b√†i ngay' : 'T·∫°o b√†i t·∫≠p'}
                            </button>
                            <button onclick="changeView('competition')" class="bg-blue-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-900 transition flex items-center gap-2">
                                <i data-lucide="swords" size="16"></i> ƒê·∫•u tr∆∞·ªùng
                            </button>
                        </div>
                    </div>
                    <i data-lucide="trophy" class="w-32 h-32 opacity-20 hidden lg:block"></i>
                </div>
            `;
        };

        // ASSIGNMENTS (Logic t·∫°o b√†i t·∫≠p ƒë·∫ßy ƒë·ªß t·ª´ LMS_App10)
        const renderAssignments = () => {
            if (state.ui.isCreatingAssignment) {
                return renderCreateAssignmentForm();
            }
            if (state.ui.takingAssignmentId) {
                return renderTakeAssignment();
            }

            const list = state.data.assignments.map(a => {
                const sub = state.data.submissions.find(s => s.assignmentId === a.id && s.studentId === state.user.uid);
                
                let actionBtn = '';
                if (state.profile.role === 'student') {
                    if (sub) actionBtn = `<button disabled class="w-full bg-slate-100 text-slate-400 py-2 rounded-lg font-medium cursor-not-allowed">ƒê√£ xong (${sub.score}ƒë)</button>`;
                    else actionBtn = `<button onclick="startAssignment('${a.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium">L√†m b√†i</button>`;
                } else {
                    actionBtn = `<div class="text-sm text-slate-400">ID: ${a.id.substr(0,8)}...</div>`;
                }

                return `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg text-blue-600"><i data-lucide="book-open"></i></div>
                            ${sub ? '<i data-lucide="check-circle" class="text-green-500"></i>' : ''}
                        </div>
                        <h4 class="text-lg font-bold text-slate-800 mb-2">${a.title}</h4>
                        <p class="text-slate-500 text-sm mb-4">${a.questions.length} c√¢u h·ªèi</p>
                        ${actionBtn}
                    </div>
                `;
            }).join('');

            return `
                ${state.profile.role === 'teacher' ? 
                    `<button onclick="toggleCreate(true)" class="mb-6 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-md flex items-center gap-2">
                        <i data-lucide="plus-circle"></i> T·∫°o b√†i t·∫≠p
                    </button>` : ''}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${list || '<p class="text-slate-500">Ch∆∞a c√≥ b√†i t·∫≠p n√†o.</p>'}
                </div>
            `;
        };
        
        const renderQuestionDisplay = (q) => {
            const typeLabels = {
                mcq: 'Tr·∫Øc nghi·ªám', fib: 'ƒêi·ªÅn t·ª´', jumble: 'X·∫øp t·ª´', match: 'Gh√©p ƒë√¥i', translation: 'D·ªãch c√¢u'
            };
            const typeLabel = typeLabels[q.type] || 'Kh√¥ng x√°c ƒë·ªãnh';
            
            let content = '';

            switch(q.type) {
                case 'mcq':
                    content = `ƒê√°p √°n ƒë√∫ng: Option ${q.options[q.correct]}`;
                    break;
                case 'fib':
                    content = `C√¢u: ${q.text.replace('[BLANK]', '______')}<br>ƒê√°p √°n: **${q.answer}**`;
                    break;
                case 'jumble':
                    content = `C√¢u ƒë√∫ng: **${q.answer.join(' ')}**`;
                    break;
                case 'match':
                    content = 'C√°c c·∫∑p gh√©p n·ªëi:<br>' + q.pairs.map(p => `**${p.a}** -> **${p.b}**`).join('<br>');
                    break;
                case 'translation':
                    content = `C√¢u TV: ${q.vietnamese}<br>ƒê√°p √°n TC: **${q.chinese}**`;
                    break;
            }

            return `
                <div class="p-4 border border-slate-200 rounded-xl bg-slate-50 mb-4">
                    <div class="font-bold text-blue-600 mb-2">Lo·∫°i: ${typeLabel}</div>
                    <p class="font-medium mb-2">${q.type === 'mcq' ? q.text : q.vietnamese || q.text || ''}</p>
                    <div class="text-sm text-slate-500">
                        ${content}
                    </div>
                </div>
            `;
        };

        const renderQuestionInputForm = () => {
            const type = state.ui.newQuestionType;
            let inputs = '';
            
            switch (type) {
                case 'mcq':
                    inputs = `
                        <input id="q-text" class="w-full p-2 border rounded-lg mb-3" placeholder="N·ªôi dung c√¢u h·ªèi">
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input id="opt-0" class="p-2 border rounded" placeholder="ƒê√°p √°n 1">
                            <input id="opt-1" class="p-2 border rounded" placeholder="ƒê√°p √°n 2">
                            <input id="opt-2" class="p-2 border rounded" placeholder="ƒê√°p √°n 3">
                            <input id="opt-3" class="p-2 border rounded" placeholder="ƒê√°p √°n 4">
                        </div>
                        <select id="q-correct" class="w-full p-2 border rounded mb-3">
                            <option value="0">ƒê√°p √°n 1 ƒë√∫ng</option>
                            <option value="1">ƒê√°p √°n 2 ƒë√∫ng</option>
                            <option value="2">ƒê√°p √°n 3 ƒë√∫ng</option>
                            <option value="3">ƒê√°p √°n 4 ƒë√∫ng</option>
                        </select>
                    `;
                    break;
                case 'fib':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">S·ª≠ d·ª•ng chu·ªói <code>[BLANK]</code> ƒë·ªÉ ƒë√°nh d·∫•u v·ªã tr√≠ ƒëi·ªÅn t·ª´.</p>
                        <input id="fib-text" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: H√¥m nay t√¥i ƒëi [BLANK]...">
                        <input id="fib-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ƒë√∫ng (V√≠ d·ª•: ch·ª£)">
                    `;
                    break;
                case 'jumble':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p c√¢u ƒë√∫ng. C√°c t·ª´ s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t√°ch v√† x√°o tr·ªôn.</p>
                        <input id="jumble-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: T√¥i y√™u h·ªçc ti·∫øng Vi·ªát">
                    `;
                    break;
                case 'match':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p 3 c·∫∑p gh√©p n·ªëi (C·ªôt A: C√¢u h·ªèi, C·ªôt B: ƒê√°p √°n).</p>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input id="match-a0" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 1">
                            <input id="match-b0" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 1">
                            <input id="match-a1" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 2">
                            <input id="match-b1" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 2">
                            <input id="match-a2" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 3">
                            <input id="match-b2" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 3">
                        </div>
                    `;
                    break;
                case 'translation':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Y√™u c·∫ßu d·ªãch c√¢u ti·∫øng Vi·ªát sang ti·∫øng Trung.</p>
                        <input id="trans-vn" class="w-full p-2 border rounded-lg mb-3" placeholder="C√¢u ti·∫øng Vi·ªát (V√≠ d·ª•: T√¥i y√™u b·∫°n)">
                        <input id="trans-cn" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ti·∫øng Trung (V√≠ d·ª•: ÊàëÁà±‰Ω†)">
                    `;
                    break;
            }

            return inputs;
        };

        const renderCreateAssignmentForm = () => {
            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q)).join('');

            return `
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between mb-6">
                        <h3 class="text-xl font-bold">T·∫°o b√†i t·∫≠p m·ªõi</h3>
                        <button onclick="toggleCreate(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    <div class="mb-6">
                        <input id="new-assign-title" class="w-full text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-blue-500" placeholder="Ti√™u ƒë·ªÅ b√†i t·∫≠p...">
                    </div>
                    
                    <div id="questions-preview" class="space-y-4">${qList}</div>

                    <div class="p-4 border border-blue-200 rounded-xl bg-blue-50 mb-6">
                        <h4 class="font-bold text-blue-800 mb-3">Th√™m c√¢u h·ªèi</h4>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-blue-800 mb-1">Ch·ªçn lo·∫°i c√¢u h·ªèi</label>
                            <select id="q-type-select" onchange="changeQuestionType(this.value)" class="w-full p-2 border border-blue-300 rounded-lg">
                                <option value="mcq" ${state.ui.newQuestionType === 'mcq' ? 'selected' : ''}>1. Tr·∫Øc nghi·ªám</option>
                                <option value="fib" ${state.ui.newQuestionType === 'fib' ? 'selected' : ''}>2. ƒêi·ªÅn t·ª´ c√≤n thi·∫øu</option>
                                <option value="jumble" ${state.ui.newQuestionType === 'jumble' ? 'selected' : ''}>3. X·∫øp t·ª´ th√†nh c√¢u</option>
                                <option value="match" ${state.ui.newQuestionType === 'match' ? 'selected' : ''}>4. Gh√©p ƒë√¥i</option>
                                <option value="translation" ${state.ui.newQuestionType === 'translation' ? 'selected' : ''}>5. D·ªãch c√¢u (Vi·ªát - Trung)</option>
                            </select>
                        </div>

                        ${renderQuestionInputForm()}

                        <button onclick="addQuestion()" class="text-blue-600 font-bold text-sm mt-3">+ Th√™m v√†o danh s√°ch</button>
                    </div>

                    <button onclick="publishAssignment()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">Xu·∫•t b·∫£n b√†i t·∫≠p</button>
                </div>
            `;
        };

        const renderTakeAssignmentQuestion = (q, qIdx) => {
            let qContent = '';
            const answerKey = `q-${qIdx}`;
            
            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            switch(q.type) {
                case 'mcq':
                    qContent = q.options.map((opt, oIdx) => {
                        const isSelected = state.ui.assignmentAnswers[qIdx] === oIdx;
                        return `
                        <label class="block p-3 border rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-blue-50 border-blue-500' : 'hover:bg-slate-50'}">
                            <input type="radio" name="${answerKey}" class="hidden" onclick="selectAnswer(${qIdx}, ${oIdx})" ${isSelected ? 'checked' : ''}>
                            <div class="flex items-center gap-3">
                                <div class="w-5 h-5 rounded-full border flex items-center justify-center ${isSelected ? 'border-blue-500' : 'border-slate-300'}">
                                    ${isSelected ? '<div class="w-3 h-3 bg-blue-500 rounded-full"></div>' : ''}
                                </div>
                                ${opt}
                            </div>
                        </label>`;
                    }).join('');
                    break;

                case 'fib':
                    const currentFibAnswer = state.ui.assignmentAnswers[qIdx] || '';
                    qContent = `
                        <p class="text-lg mb-3">${q.text.replace('[BLANK]', '______')}</p>
                        <input id="${answerKey}-input" oninput="captureInputAnswer(${qIdx}, this.value)" class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p t·ª´ c√≤n thi·∫øu..." value="${currentFibAnswer}">
                    `;
                    break;

                case 'translation':
                    const currentTransAnswer = state.ui.assignmentAnswers[qIdx] || '';
                    qContent = `
                        <p class="text-lg mb-3 font-bold text-slate-700">D·ªãch c√¢u sau sang ti·∫øng Trung:</p>
                        <p class="text-xl mb-4 text-blue-600 italic">"${q.vietnamese}"</p>
                        <textarea id="${answerKey}-input" oninput="captureInputAnswer(${qIdx}, this.value)" rows="3" class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi b·∫±ng ti·∫øng Trung...">
${currentTransAnswer}</textarea>
                    `;
                    break;
                
                case 'jumble':
                    const initialWords = q.answer;
                    const scrambledWords = shuffleArray([...initialWords]);
                    const currentJumbleOrder = state.ui.assignmentAnswers[qIdx] || [];
                    const wordsInUse = currentJumbleOrder;
                    const availableWords = scrambledWords.filter(word => !wordsInUse.includes(word));

                    qContent = `
                        <p class="text-lg mb-3 font-bold text-slate-700">S·∫Øp x·∫øp c√°c t·ª´ sau ƒë·ªÉ t·∫°o th√†nh c√¢u ƒë√∫ng:</p>
                        
                        <div id="${answerKey}-drop-area" class="min-h-[60px] p-2 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50 flex flex-wrap items-center mb-4">
                            ${wordsInUse.map((word, wIdx) => 
                                `<span class="jumble-word bg-green-100 border-green-600 text-green-700" onclick="removeJumbleWord(${qIdx}, '${word}', ${wIdx})">${word}</span>`
                            ).join('')}
                        </div>
                        
                        <p class="text-sm font-medium text-slate-600 mb-2">C√°c t·ª´ c√≥ s·∫µn:</p>
                        <div id="${answerKey}-bank" class="min-h-[40px] p-2 border border-slate-200 rounded-lg bg-white flex flex-wrap items-center">
                            ${availableWords.map(word => 
                                `<span class="jumble-word" onclick="addJumbleWord(${qIdx}, '${word}')">${word}</span>`
                            ).join('')}
                        </div>
                    `;
                    break;
                
                case 'match':
                    const currentMatches = state.ui.assignmentAnswers[qIdx] || {}; 
                    const pairs = q.pairs;
                    const colA = pairs.map(p => p.a);
                    const colB = shuffleArray(pairs.map(p => p.b));

                    qContent = `
                        <p class="text-lg mb-3 font-bold text-slate-700">Gh√©p ƒë√¥i c√°c m·ª•c sau:</p>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Column A (Questions) -->
                            <div class="space-y-4">
                                ${colA.map((item, aIdx) => {
                                    const selectedBIndex = currentMatches[aIdx];
                                    
                                    return `
                                        <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            <p class="font-medium text-slate-800 mb-2">A${aIdx + 1}: ${item}</p>
                                            <select 
                                                id="match-a-${aIdx}" 
                                                onchange="selectMatchAnswer(${qIdx}, ${aIdx}, this.value, [${colB.map(b => `'${b}'`)}])" 
                                                class="w-full p-2 border rounded-lg bg-slate-50 focus:ring-blue-500"
                                            >
                                                <option value="">Ch·ªçn...</option>
                                                ${colB.map((bItem, bIdx) => 
                                                    `<option value="${bIdx}" ${selectedBIndex === bIdx ? 'selected' : ''}>${bItem}</option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    break;
            }

            return `
                <div class="mb-6">
                    <p class="font-medium text-lg mb-3 text-slate-800"><span class="font-bold text-blue-600">C√¢u ${qIdx+1}:</span> ${q.type === 'translation' ? '' : q.text}</p>
                    <div class="space-y-2">
                        ${qContent}
                    </div>
                </div>
            `;
        }

        const renderTakeAssignment = () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if(!assign) return '';
            
            const qHtml = assign.questions.map((q, qIdx) => renderTakeAssignmentQuestion(q, qIdx)).join('');

            return `
                <div class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b">
                        <h3 class="text-2xl font-bold">${assign.title}</h3>
                        <button onclick="startAssignment(null)" class="text-slate-400"><i data-lucide="x"></i></button>
                    </div>
                    <div>${qHtml}</div>
                    <div class="mt-8 pt-6 border-t">
                        <button onclick="submitAssignment()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold text-lg shadow-lg">N·ªôp b√†i</button>
                    </div>
                </div>
            `;
        };

        // RANKING
        const renderRanking = () => {
            const sorted = [...state.data.users].sort((a,b) => (b.points||0) - (a.points||0));
            return `
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div class="bg-yellow-400 p-6 flex justify-center">
                        <i data-lucide="trophy" class="text-white w-16 h-16 drop-shadow-md"></i>
                    </div>
                    <div class="p-6">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-slate-500 text-sm border-b">
                                    <th class="pb-3 pl-4">H·∫°ng</th>
                                    <th class="pb-3">H·ªçc sinh</th>
                                    <th class="pb-3 text-right pr-4">ƒêi·ªÉm s·ªë</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sorted.map((u, idx) => {
                                    let isMe = u.uid === state.user.uid;
                                    return `
                                    <tr class="border-b last:border-0 hover:bg-slate-50 transition ${isMe ? 'bg-blue-50' : ''}">
                                        <td class="py-4 pl-4 font-bold text-slate-500">#${idx+1}</td>
                                        <td class="py-4 flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white ${u.role === 'teacher' ? 'bg-purple-400' : 'bg-blue-400'}">
                                                ${u.name.charAt(0)}
                                            </div>
                                            <span class="font-medium ${isMe ? 'text-blue-700' : 'text-slate-700'}">${u.name} ${isMe ? '(B·∫°n)' : ''}</span>
                                        </td>
                                        <td class="py-4 text-right pr-4 font-bold text-slate-800">${u.points || 0}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };


        // --- COMPETITION RENDERERS (OPTIMIZED FOR NO FLICKER) ---

        const renderCompetitionLobby = () => `
            <div class="text-center py-12 bg-white rounded-3xl shadow-xl">
                <div class="inline-block p-6 bg-purple-100 rounded-full mb-6">
                    <i data-lucide="swords" class="w-16 h-16 text-purple-600"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-800 mb-6">ƒê·∫•u tr∆∞·ªùng T·ª´ v·ª±ng</h2>
                <div class="mb-6">
                    <p class="text-slate-500">S·ªë l∆∞·ª£ng t·ª´ v·ª±ng hi·ªán c√≥: <span class="font-bold text-blue-600">${state.data.vocabulary.length}</span></p>
                    <p class="text-xs text-slate-400 mt-1">(D·ªØ li·ªáu load t·ª´ dataLMS/data.txt)</p>
                </div>
                <div class="flex justify-center gap-8">
                    <button onclick="createMatch()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-4 rounded-2xl font-bold text-lg shadow-xl transition transform hover:-translate-y-1">
                        T·∫°o Ph√≤ng M·ªõi
                    </button>
                    <button onclick="setCompetitionMode('join')" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-bold text-lg shadow-xl transition transform hover:-translate-y-1">
                        Tham Gia Ph√≤ng
                    </button>
                </div>
            </div>
        `;

        const renderCompetitionJoin = () => `
            <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl text-center">
                <h3 class="text-2xl font-bold text-slate-700 mb-6">Nh·∫≠p M√£ Ph√≤ng</h3>
                <input id="room-code-input" type="text" class="w-full p-4 border-2 border-slate-300 rounded-xl text-center text-xl font-bold tracking-widest uppercase mb-4" maxlength="6" placeholder="CODE">
                <button onclick="joinMatch()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-4">Tham Gia</button>
                <button onclick="setCompetitionMode('lobby')" class="text-slate-500">Quay l·∫°i</button>
            </div>
        `;

        const renderCompetitionWaiting = (match) => {
            const isOwner = match.player1.uid === state.user.uid;
            return `
                <div class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl text-center">
                    <h3 class="text-2xl font-bold text-slate-700 mb-2">Ph√≤ng ch·ªù: <span class="text-purple-600">${match.roomCode}</span></h3>
                    <p class="text-slate-500 mb-6">Chia s·∫ª m√£ n√†y cho ƒë·ªëi th·ªß.</p>
                    <div class="flex justify-center gap-8 mb-8">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-600 font-bold text-xl">${match.player1.name.charAt(0)}</div>
                            <p class="font-bold text-blue-700">${match.player1.name}</p>
                        </div>
                        <div class="self-center font-bold text-slate-300 text-xl">VS</div>
                        <div class="text-center">
                            <div class="w-16 h-16 ${match.player2 ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-400'} rounded-full flex items-center justify-center mx-auto mb-2 font-bold text-xl">
                                ${match.player2 ? match.player2.name.charAt(0) : '?'}
                            </div>
                            <p class="font-bold ${match.player2 ? 'text-red-700' : 'text-slate-400'}">${match.player2 ? match.player2.name : 'ƒêang ch·ªù...'}</p>
                        </div>
                    </div>
                    ${isOwner && match.player2 ? `<button onclick="startMatch('${match.id}')" class="bg-green-600 text-white py-3 px-8 rounded-xl font-bold text-lg animate-pulse">B·∫Øt ƒë·∫ßu ngay</button>` : ''}
                    ${!match.player2 ? `<button onclick="leaveMatch('${match.id}')" class="mt-4 text-red-500">H·ªßy ph√≤ng</button>` : ''}
                </div>
            `;
        };

        const renderCompetitionPlaying = (match) => {
            return `
                <div id="match-playing-container" class="max-w-4xl mx-auto">
                    <!-- Score Board with IDs -->
                    <div class="flex justify-between mb-8">
                        <div class="bg-blue-600 text-white px-6 py-3 rounded-xl shadow-lg transition-all duration-300" id="p1-box">
                            <p class="text-sm opacity-80">${match.player1.name}</p>
                            <p class="text-3xl font-bold" id="p1-score">${match.player1.score}</p>
                        </div>
                        <div class="bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg text-right transition-all duration-300" id="p2-box">
                            <p class="text-sm opacity-80">${match.player2.name}</p>
                            <p class="text-3xl font-bold" id="p2-score">${match.player2.score}</p>
                        </div>
                    </div>

                    <!-- Question Card -->
                    <div class="bg-white p-8 rounded-3xl shadow-2xl text-center border-b-8 border-slate-200">
                        <div class="mb-6">
                            <span id="q-counter" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-sm font-bold uppercase"></span>
                        </div>
                        
                        <div id="audio-container" class="mb-4 hidden"></div>
                        
                        <h2 id="q-text" class="text-2xl md:text-3xl font-medium text-slate-700 mb-8 leading-relaxed min-h-[4rem] flex items-center justify-center">
                            <!-- Question Text Here -->
                        </h2>

                        <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Options Buttons Here -->
                        </div>
                    </div>
                </div>
            `;
        };

        // H√†m Update th√¥ng minh (ch·∫°y m·ªói khi c√≥ d·ªØ li·ªáu m·ªõi)
        window.updatePlayingUI = () => {
            const match = state.ui.activeMatch;
            if (!match || !document.getElementById('match-playing-container')) return;

            const qIndex = match.qIndex || 0;
            const q = match.questions[qIndex];
            
            // 1. Update Scores
            document.getElementById('p1-score').textContent = match.player1.score;
            document.getElementById('p2-score').textContent = match.player2.score;

            // Highlight leader
            const p1Box = document.getElementById('p1-box');
            const p2Box = document.getElementById('p2-box');
            if (match.player1.score > match.player2.score) {
                p1Box.classList.add('scale-105', 'ring-4', 'ring-blue-300');
                p2Box.classList.remove('scale-105', 'ring-4', 'ring-red-300');
            } else if (match.player2.score > match.player1.score) {
                p2Box.classList.add('scale-105', 'ring-4', 'ring-red-300');
                p1Box.classList.remove('scale-105', 'ring-4', 'ring-blue-300');
            } else {
                p1Box.classList.remove('scale-105', 'ring-4', 'ring-blue-300');
                p2Box.classList.remove('scale-105', 'ring-4', 'ring-red-300');
            }

            // N·∫øu c√¢u h·ªèi hi·ªán t·∫°i ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi, v√¥ hi·ªáu h√≥a c√°c n√∫t
            const buttonsDisabled = state.ui.hasAnsweredCurrentQ;

            // 2. Update Counter
            document.getElementById('q-counter').textContent = `C√¢u h·ªèi ${qIndex + 1}/${match.questions.length}`;

            // 3. Update Audio Button
            const audioContainer = document.getElementById('audio-container');
            if (q.audioWord) {
                audioContainer.innerHTML = `
                    <button onclick="speakWord('${q.audioWord}')" class="inline-flex items-center gap-2 bg-purple-100 text-purple-700 px-6 py-3 rounded-full font-bold hover:bg-purple-200 transition ${buttonsDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${buttonsDisabled ? 'disabled' : ''}>
                        <i data-lucide="volume-2"></i> Nghe √¢m thanh
                    </button>`;
                audioContainer.classList.remove('hidden');
            } else {
                audioContainer.classList.add('hidden');
            }
            renderIcons();

            // 4. Update Question Text
            const qTextEl = document.getElementById('q-text');
            if (qTextEl.innerHTML !== q.text) {
                qTextEl.innerHTML = q.text;
                // Ph√°t √¢m thanh khi c√¢u h·ªèi m·ªõi load
                if (q.audioWord) setTimeout(() => speakWord(q.audioWord), 300); 
            }

            // 5. Update Options
            const grid = document.getElementById('options-grid');
            const currentQId = grid.getAttribute('data-qid');

            // C·∫≠p nh·∫≠t l·∫°i UI options ch·ªâ khi index c√¢u h·ªèi thay ƒë·ªïi
            if (currentQId !== String(qIndex) || buttonsDisabled) { 
                grid.setAttribute('data-qid', qIndex);
                grid.innerHTML = q.options.map((opt, idx) => `
                    <button id="opt-btn-${idx}" onclick="handleAnswerAttempt(${idx === q.correct}, '${match.id}', ${idx})" class="p-6 bg-slate-50 border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-700 rounded-2xl text-xl font-bold transition-all transform active:scale-95 text-slate-700 ${buttonsDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${buttonsDisabled ? 'disabled' : ''}>
                        ${opt}
                    </button>
                `).join('');
            }
        };

        // NEW HANDLER: G√°n c·ªù v√† g·ª≠i Transaction
        window.handleAnswerAttempt = async (isCorrect, mid, optionIndex) => {
            const match = state.ui.activeMatch;
            if (!match || match.status !== 'playing' || state.ui.hasAnsweredCurrentQ) return;

            // ƒê√°nh d·∫•u c·ªù tr·∫£ l·ªùi c·ª•c b·ªô ngay l·∫≠p t·ª©c
            state.ui.hasAnsweredCurrentQ = true;

            // Highlight ƒë√°p √°n ƒë√£ ch·ªçn (ƒê√∫ng: xanh, Sai: ƒë·ªè)
            const btn = document.getElementById(`opt-btn-${optionIndex}`);
            if (btn) {
                btn.disabled = true;
                if (isCorrect) {
                    btn.classList.add('bg-green-500', 'text-white', 'scale-105', 'shadow-lg');
                } else {
                    btn.classList.add('bg-red-500', 'text-white', 'scale-105', 'shadow-lg');
                    // T√πy ch·ªçn: Highlight ƒë√°p √°n ƒë√∫ng sau 1s n·∫øu tr·∫£ l·ªùi sai
                    const correctBtn = document.getElementById(`opt-btn-${match.questions[match.qIndex].correct}`);
                    if (correctBtn) {
                         setTimeout(() => {
                            correctBtn.classList.add('bg-green-500', 'ring-2', 'ring-green-700');
                        }, 500);
                    }
                }
            }

            // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ c√°c n√∫t kh√°c (ngƒÉn ch·∫∑n thao t√°c ti·∫øp theo)
            const allBtns = document.getElementById('options-grid').querySelectorAll('button');
            allBtns.forEach(b => b.disabled = true);


            // N·∫øu tr·∫£ l·ªùi ƒë√∫ng, ti·∫øn h√†nh transaction ƒë·ªÉ c·∫≠p nh·∫≠t ƒëi·ªÉm v√† chuy·ªÉn c√¢u h·ªèi
            if (isCorrect) {
                try {
                    await runTransaction(db, async (transaction) => {
                        const matchRef = doc(db, getPath('matches'), mid);
                        const matchDoc = await transaction.get(matchRef);

                        if (!matchDoc.exists) {
                            throw "Match does not exist!";
                        }

                        const matchData = matchDoc.data();
                        const currentQIndex = matchData.qIndex || 0;
                        const questionsLength = matchData.questions.length;

                        // Ch·ªâ x·ª≠ l√Ω n·∫øu c√¢u h·ªèi hi·ªán t·∫°i ch∆∞a ƒë∆∞·ª£c chuy·ªÉn
                        if (currentQIndex === state.ui.matchQIndex) {
                            const isP1 = match.player1.uid === state.user.uid;
                            const newScore = (isP1 ? matchData.player1.score : matchData.player2.score) + 10;
                            const nextQIndex = currentQIndex + 1;
                            
                            const updateData = {};
                            
                            // 1. C·∫≠p nh·∫≠t ƒëi·ªÉm
                            updateData[isP1 ? "player1.score" : "player2.score"] = newScore;
                            
                            // 2. Chuy·ªÉn c√¢u h·ªèi ho·∫∑c k·∫øt th√∫c
                            if (nextQIndex < questionsLength) {
                                updateData.qIndex = nextQIndex;
                            } else {
                                updateData.status = 'finished';
                            }
                            
                            // 3. Th·ª±c hi·ªán update
                            transaction.update(matchRef, updateData);
                            
                            // C·∫≠p nh·∫≠t ƒëi·ªÉm t√≠ch l≈©y ngay khi k·∫øt th√∫c (d√π logic ch√≠nh s·∫Ω n·∫±m trong listener, nh∆∞ng ƒë√¢y l√† b∆∞·ªõc chu·∫©n b·ªã)
                            if (updateData.status === 'finished') {
                                const userRef = doc(db, getPath('users'), state.user.uid);
                                const userDoc = await transaction.get(userRef);
                                
                                // N·∫øu l√† ng∆∞·ªùi chi·∫øn th·∫Øng, c·ªông th√™m ƒëi·ªÉm chi·∫øn th·∫Øng (V√≠ d·ª•: 50 ƒëi·ªÉm bonus)
                                // Tuy nhi√™n, theo y√™u c·∫ßu, ƒëi·ªÉm t√≠ch l≈©y ch·ªâ ƒë∆∞·ª£c c·ªông ƒëi·ªÉm thi ƒë·∫•u (newScore) n·∫øu l√† ng∆∞·ªùi th·∫Øng chung cu·ªôc
                                
                                // T·∫°m th·ªùi b·ªè qua logic th·∫Øng chung cu·ªôc ph·ª©c t·∫°p trong transaction, ch·ªâ l∆∞u ƒëi·ªÉm thi ƒë·∫•u
                                transaction.update(matchRef, {...updateData, winnerScore: newScore, finishedBy: state.user.uid});
                            }

                            // C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ª•c b·ªô ƒë·ªÉ UI kh√¥ng c·∫ßn ƒë·ª£i Firestore update cho vi·ªác chuy·ªÉn c√¢u h·ªèi
                            state.ui.matchQIndex = nextQIndex;
                            updatePlayingUI();
                        }
                    });
                } catch (e) {
                    // N·∫øu transaction th·∫•t b·∫°i (v√≠ d·ª•: ng∆∞·ªùi kh√°c ƒë√£ tr·∫£ l·ªùi v√† chuy·ªÉn c√¢u h·ªèi tr∆∞·ªõc)
                    console.error("Transaction failed:", e);
                    // UI s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t th√¥ng qua listener khi Firestore sync
                }

            } else {
                // Tr·∫£ l·ªùi sai: ƒê·ª£i ng∆∞·ªùi kh√°c tr·∫£ l·ªùi ƒë√∫ng ho·∫∑c h·∫øt gi·ªù (logic hi·ªán t·∫°i l√† ƒë·ª£i ng∆∞·ªùi kh√°c tr·∫£ l·ªùi)
                // C·∫ßn 2 gi√¢y ƒë·ªÉ ng∆∞·ªùi ch∆°i th·∫•y ƒë√°p √°n sai tr∆∞·ªõc khi listener sync
                 setTimeout(() => {
                    // C·∫≠p nh·∫≠t l·∫°i UI sau 1.5 gi√¢y ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi tr·∫°ng th√°i Firestore
                    if (state.ui.activeMatch) {
                        state.ui.matchQIndex = state.ui.activeMatch.qIndex || 0;
                    }
                    state.ui.hasAnsweredCurrentQ = false;
                    updatePlayingUI();
                }, 1500); 
            }
        };

        const renderCompetition = () => {
            const mode = state.ui.competitionMode;
            const match = state.ui.activeMatch;
            switch(mode) {
                case 'create': return renderCompetitionCreate(); // Placeholder
                case 'join': return renderCompetitionJoin();
                case 'waiting': return renderCompetitionWaiting(match);
                case 'playing': 
                    // Reset c·ªù khi v√†o c√¢u h·ªèi m·ªõi (D√πng c·ªù n√†y trong listener ƒë·ªÉ reset)
                    // if (match.qIndex !== state.ui.matchQIndex) { state.ui.hasAnsweredCurrentQ = false; }
                    setTimeout(updatePlayingUI, 50);
                    return renderCompetitionPlaying(match);
                case 'lobby': default: return renderCompetitionLobby();
            }
        };


        // --- 7. HANDLERS (Assignments & Competition) ---

        // V·∫´n gi·ªØ nguy√™n logic Assignment...

        window.renderCompetitionCreate = () => `<div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl text-center">
                <h3 class="text-2xl font-bold text-slate-700 mb-6">T·∫°o ph√≤ng ƒë·∫•u m·ªõi</h3>
                <button onclick="createMatch()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-md transition">
                    T·∫°o Ph√≤ng Ngay (10 C√¢u h·ªèi)
                </button>
                <button onclick="setCompetitionMode('lobby')" class="mt-4 w-full text-slate-500 hover:text-slate-700 transition text-sm">Quay l·∫°i</button>
            </div>`; // Placeholder implementation

        window.changeQuestionType = (type) => { state.ui.newQuestionType = type; renderApp(); };
        window.toggleCreate = (val) => {
            state.ui.isCreatingAssignment = val;
            if(val) {
                state.ui.newAssignment = { title: '', questions: [] };
                state.ui.newQuestionType = 'mcq';
            }
            renderApp();
        };

        // --- H√†m t·∫°o c√¢u h·ªèi v√† c√°c h√†m li√™n quan ƒë·∫øn Assignment (Gi·ªØ nguy√™n) ---

        window.addQuestion = () => {
            // ... (Logic addQuestion gi·ªØ nguy√™n) ...
            const type = state.ui.newQuestionType;
            let newQ = { type };
            let isValid = false;

            try {
                switch(type) {
                    case 'mcq':
                        const txt = document.getElementById('q-text').value;
                        const opts = [
                            document.getElementById('opt-0').value,
                            document.getElementById('opt-1').value,
                            document.getElementById('opt-2').value,
                            document.getElementById('opt-3').value
                        ];
                        const correct = parseInt(document.getElementById('q-correct').value);
                        if(!txt || opts.some(o => !o)) throw new Error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß n·ªôi dung c√¢u h·ªèi v√† 4 ƒë√°p √°n.");
                        newQ = { ...newQ, text: txt, options: opts, correct };
                        isValid = true;
                        document.getElementById('q-text').value = '';
                        opts.forEach((_, idx) => document.getElementById(`opt-${idx}`).value = '');
                        break;
                    case 'fib':
                        const fibText = document.getElementById('fib-text').value;
                        const fibAnswer = document.getElementById('fib-answer').value.trim();
                        if (!fibText.includes('[BLANK]')) throw new Error("N·ªôi dung c√¢u h·ªèi ph·∫£i c√≥ chu·ªói [BLANK] ƒë·ªÉ ƒëi·ªÅn t·ª´.");
                        if (!fibAnswer) throw new Error("Vui l√≤ng cung c·∫•p ƒë√°p √°n ƒë√∫ng.");
                        newQ = { ...newQ, text: fibText, answer: fibAnswer };
                        isValid = true;
                        document.getElementById('fib-text').value = '';
                        document.getElementById('fib-answer').value = '';
                        break;
                    case 'jumble':
                        const jumbleText = document.getElementById('jumble-answer').value.trim();
                        if (!jumbleText) throw new Error("Vui l√≤ng nh·∫≠p c√¢u ƒë√∫ng.");
                        const words = jumbleText.split(/\s+/).filter(w => w.length > 0);
                        if (words.length < 2) throw new Error("C√¢u ph·∫£i c√≥ √≠t nh·∫•t 2 t·ª´.");
                        newQ = { ...newQ, text: jumbleText, answer: words }; 
                        isValid = true;
                        document.getElementById('jumble-answer').value = '';
                        break;
                    case 'match':
                        const pairs = [];
                        for(let i=0; i<3; i++) {
                            const a = document.getElementById(`match-a${i}`).value.trim();
                            const b = document.getElementById(`match-b${i}`).value.trim();
                            if (!a || !b) throw new Error(`Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß C·∫∑p gh√©p n·ªëi ${i+1}.`);
                            pairs.push({ a, b });
                            document.getElementById(`match-a${i}`).value = '';
                            document.getElementById(`match-b${i}`).value = '';
                        }
                        newQ = { ...newQ, pairs, text: "Gh√©p ƒë√¥i c√°c m·ª•c sau:" };
                        isValid = true;
                        break;
                    case 'translation':
                        const vn = document.getElementById('trans-vn').value.trim();
                        const cn = document.getElementById('trans-cn').value.trim();
                        if (!vn || !cn) throw new Error("Vui l√≤ng nh·∫≠p c·∫£ c√¢u ti·∫øng Vi·ªát v√† c√¢u ti·∫øng Trung.");
                        newQ = { ...newQ, vietnamese: vn, chinese: cn, text: vn };
                        isValid = true;
                        document.getElementById('trans-vn').value = '';
                        document.getElementById('trans-cn').value = '';
                        break;
                }
            } catch (e) {
                return showToast(e.message, "error");
            }
            if (isValid) {
                state.ui.newAssignment.questions.push(newQ);
                renderApp(); 
            }
        };

        window.publishAssignment = async () => {
            const title = document.getElementById('new-assign-title').value;
            if(!title || state.ui.newAssignment.questions.length === 0) return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");
            
            try {
                await addDoc(getRef('assignments'), {
                    ...state.ui.newAssignment,
                    title,
                    createdBy: state.user.uid,
                    createdAt: serverTimestamp()
                });
                toggleCreate(false);
                showToast("ƒê√£ t·∫°o b√†i t·∫≠p!");
            } catch(e) { 
                console.error("Firestore Error when publishing assignment:", e);
                showToast("L·ªói t·∫°o b√†i: Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p Firebase.", "error"); 
            }
        };

        window.startAssignment = (id) => {
            state.ui.takingAssignmentId = id;
            state.ui.assignmentAnswers = {};
            renderApp();
        };
        
        window.selectAnswer = (qIdx, oIdx) => { state.ui.assignmentAnswers[qIdx] = oIdx; renderApp(); };
        window.captureInputAnswer = (qIdx, value) => { state.ui.assignmentAnswers[qIdx] = value; };
        window.getJumbleAnswer = (qIdx) => { return state.ui.assignmentAnswers[qIdx] || []; };
        window.addJumbleWord = (qIdx, word) => { const currentOrder = window.getJumbleAnswer(qIdx); state.ui.assignmentAnswers[qIdx] = [...currentOrder, word]; renderApp(); };
        window.removeJumbleWord = (qIdx, wordToRemove, wIdx) => { const currentOrder = window.getJumbleAnswer(qIdx); currentOrder.splice(wIdx, 1); state.ui.assignmentAnswers[qIdx] = currentOrder; renderApp(); };
        
        window.selectMatchAnswer = (qIdx, aIdx, bIdxValue, colB) => {
            const currentMatches = state.ui.assignmentAnswers[qIdx] || {};
            if (bIdxValue === "") { delete currentMatches[aIdx]; } else {
                const bIdx = parseInt(bIdxValue);
                for (const key in currentMatches) {
                    if (currentMatches[key] === bIdx && parseInt(key) !== aIdx) { delete currentMatches[key]; }
                }
                currentMatches[aIdx] = bIdx;
            }
            state.ui.assignmentAnswers[qIdx] = {...currentMatches};
            renderApp();
        };

        window.submitAssignment = async () => {
            // ... (Logic submitAssignment gi·ªØ nguy√™n) ...
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            let score = 0;
            const totalQuestions = assign.questions.length;
            
            assign.questions.forEach((q, idx) => {
                const userAnswer = state.ui.assignmentAnswers[idx];
                let isCorrect = false;

                switch(q.type) {
                    case 'mcq':
                        isCorrect = userAnswer === q.correct;
                        break;
                    case 'fib':
                    case 'translation':
                        if (userAnswer) {
                            const expectedAnswer = q.type === 'fib' ? q.answer : q.chinese;
                            isCorrect = userAnswer.trim().toLowerCase() === expectedAnswer.trim().toLowerCase();
                        }
                        break;
                    case 'jumble':
                        if (Array.isArray(userAnswer)) {
                            isCorrect = q.answer.join(' ') === userAnswer.join(' ');
                        }
                        break;
                    case 'match':
                        if (q.type === 'match') {
                            isCorrect = Object.keys(userAnswer || {}).length === q.pairs.length;
                        }
                        break;
                }
                
                if (isCorrect) score += (100 / totalQuestions); 
            });

            score = Math.round(score);

            try {
                await addDoc(getRef('submissions'), {
                    assignmentId: assign.id,
                    studentId: state.user.uid,
                    score,
                    answers: state.ui.assignmentAnswers,
                    createdAt: serverTimestamp()
                });
                await updateDoc(doc(db, getPath('users'), state.user.uid), {
                    points: (state.profile.points || 0) + score
                });
                state.ui.takingAssignmentId = null;
                showToast(`N·ªôp b√†i th√†nh c√¥ng! +${score} ƒëi·ªÉm`);
            } catch(e) { showToast("L·ªói n·ªôp b√†i", "error"); }
        };

        // General Auth Handlers
        window.setAuthMode = (m) => { state.ui.authMode = m; renderApp(); };
        window.changeView = (v) => { 
            state.view = v; 
            if(v!=='competition') { state.ui.competitionMode='lobby'; state.ui.activeMatch=null; }
            if(v==='competition') loadVocabulary();
            renderApp(); 
        };
        window.setCompetitionMode = (m) => { state.ui.competitionMode = m; renderApp(); };
        window.handleLogin = async (e) => { e.preventDefault(); const email=document.getElementById('login-email').value; const pass=document.getElementById('login-password').value; await signInWithEmailAndPassword(auth,email,pass).catch(e=>showToast("L·ªói ƒëƒÉng nh·∫≠p: Vui l√≤ng ki·ªÉm tra Email/M·∫≠t kh·∫©u.",'error')); };
        window.handleRegister = async (e) => { 
            e.preventDefault(); 
            const email=document.getElementById('join-email').value; 
            const pass=document.getElementById('join-password').value; 
            const name=document.getElementById('join-name').value;
            const role = document.querySelector('input[name="role"]:checked').value;
            if (role === 'teacher' && document.getElementById('teacher-code').value !== TEACHER_CODE) return showToast("Sai m√£ gi√°o vi√™n", "error");
            try {
                const cred = await createUserWithEmailAndPassword(auth,email,pass);
                await setDoc(doc(db,getPath('users'),cred.user.uid),{uid:cred.user.uid,name,role,points:0,email,createdAt:serverTimestamp()});
                showToast("ƒêƒÉng k√Ω th√†nh c√¥ng!");
            } catch(e) { showToast(`L·ªói ƒëƒÉng k√Ω: ${e.code.replace('auth/', '')}`, 'error'); }
        };
        window.handleSignOut = async () => { await signOut(auth); window.location.reload(); };

        // Competition Handlers
        window.createMatch = async () => {
            if(state.data.vocabulary.length<4) await loadVocabulary();
            const questions = generateArenaQuestions();
            if (questions.length === 0) return;
            const roomCode = generateRoomCode();
            // Kh·ªüi t·∫°o qIndex = 0
            await addDoc(getRef('matches'), { roomCode, player1:{uid:state.user.uid,name:state.profile.name,score:0}, player2:null, status:'waiting', questions, qIndex: 0, createdAt: serverTimestamp() });
            state.ui.competitionMode='waiting'; showToast(`T·∫°o ph√≤ng ${roomCode}`);
        };

        window.joinMatch = async () => {
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (code.length !== 6) return showToast("M√£ ph√≤ng kh√¥ng h·ª£p l·ªá", "error");
            const snap = await getDocs(query(getRef('matches'), where('roomCode','==',code), where('status','==','waiting')));
            if(snap.empty) return showToast("Ph√≤ng kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ ƒë·∫ßy", "error");
            const docRef = snap.docs[0];
            if(docRef.data().player1.uid===state.user.uid) return showToast("B·∫°n ƒë√£ ·ªü trong ph√≤ng n√†y");
            await updateDoc(doc(db,getPath('matches'),docRef.id), { player2:{uid:state.user.uid,name:state.profile.name,score:0} });
            state.ui.competitionMode='waiting'; showToast("ƒê√£ tham gia ph√≤ng!");
        };

        window.startMatch = async (mid) => updateDoc(doc(db,getPath('matches'),mid), {status:'playing', startTime: serverTimestamp()});
        window.leaveMatch = async (mid) => { deleteDoc(doc(db,getPath('matches'),mid)); state.ui.activeMatch=null; state.ui.competitionMode='lobby'; renderApp(); };


        // Bootstrap
        onAuthStateChanged(auth, (u) => {
            state.user = u; state.isAuthReady = true;
            if(u) setupListeners(u.uid);
            else { state.profile = null; state.ui.authMode = 'login'; renderApp(); }
        });

        initAuth();

    </script>
</body>
</html>